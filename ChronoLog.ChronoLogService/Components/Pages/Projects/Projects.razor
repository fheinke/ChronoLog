@page "/projects"
@using ChronoLog.Core.Interfaces
@using ChronoLog.Core.Models.DisplayObjects
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IProjectService ProjectService

<PageTitle>Projects</PageTitle>

<div style="display: flex; flex-direction: column; height: 100%; gap: 10px;">
    <RadzenCard>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <RadzenButton Text="Create Project" ButtonStyle="ButtonStyle.Success" Variant="Variant.Outlined" Click="OpenCreateProjectDialog"/>
        </div>
    </RadzenCard>
    <RadzenCard>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 10px;">
                <RadzenTextBox @bind-Value="_searchText" Placeholder="Search" Change="OnSearchTextChanged"/>
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <RadzenButton Text="Clear Filters" Click="ClearAllFilters"/>
                <RadzenButton Icon="refresh" Variant="Variant.Outlined" Click="LoadData"/>
            </div>
        </div>

        <div style="flex: 1; overflow: auto; height: calc(100% - 64px); margin: 10px 0 0 0;">
            <RadzenDataGrid class="rz-data-grid"
                            @ref="_grid"
                            @bind-Value="_selectedProject"
                            Data="@FilteredProjects"
                            AllowFiltering="true"
                            AllowColumnResize="true"
                            AllowRowSelectOnRowClick="true"
                            FilterMode="FilterMode.Advanced"
                            PageSize="15"
                            AllowPaging="true"
                            AllowSorting="true"
                            ColumnWidth="300px"
                            PagerHorizontalAlign="HorizontalAlign.Left"
                            ShowPagingSummary="true"
                            GridLines="DataGridGridLines.Horizontal"
                            SelectionMode="DataGridSelectionMode.Single"
                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                            LogicalFilterOperator="LogicalFilterOperator.And"
                            FilterPopupRenderMode="PopupRenderMode.OnDemand">
                <Columns>
                    <RadzenDataGridColumn Property="@nameof(ProjectModel.IsDefault)" Title="Default" Filterable="false" Sortable="false" Resizable="false" Width="30px" TextAlign="TextAlign.Center">
                        <Template Context="item">
                            @if (item.IsDefault)
                            {
                                <RadzenIcon Icon="check_circle" Style="color: green;"/>
                            }
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="@nameof(ProjectModel.Name)" Title="Project Name">
                        <Template Context="item">
                            @item.Name
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Property="@nameof(ProjectModel.ResponseObject)" Title="Response Object">
                        <Template Context="item">
                            @item.ResponseObject
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn Filterable="false" Sortable="false" Resizable="false" Width="40px" TextAlign="TextAlign.Center">
                        <Template Context="item">
                            <RadzenButton Icon="edit"
                                          ButtonStyle="ButtonStyle.Base"
                                          Size="ButtonSize.Small"
                                          Click="@(async _ => await OpenEditProjectDialog(item))"/>
                            <RadzenButton Icon="delete"
                                          ButtonStyle="ButtonStyle.Danger"
                                          Size="ButtonSize.Small"
                                          Click="@(async _ => await ConfirmDelete(item))"/>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </div>
    </RadzenCard>
</div>

@code {
    private List<ProjectModel> _projects = [];
    
    private RadzenDataGrid<ProjectModel>? _grid;
    private IList<ProjectModel>? _selectedProject;
    private string _searchText = "";
    
    private List<ProjectModel> FilteredProjects => string.IsNullOrWhiteSpace(_searchText)
        ? _projects
        : _projects.Where(p => 
            p.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) || 
            p.ProjectId.ToString().Contains(_searchText, StringComparison.OrdinalIgnoreCase)
            ).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        if (_selectedProject is null || !_selectedProject.Any())
            _selectedProject = _projects.Take(1).ToList();
    }

    private async Task LoadData()
    {
        _projects = (await ProjectService.GetProjectsAsync()).ToList();
        StateHasChanged();
    }

    private async Task ClearAllFilters()
    {
        _searchText = string.Empty;
        if (_grid is null)
            return;
        
        foreach (var column in _grid.ColumnsCollection)
            await column.SetFilterValueAsync(null);
        
        await _grid.Reload();
    }
    
    private void OnSearchTextChanged(object? value)
    {
        _searchText = value?.ToString() ?? string.Empty;
    }
    
    private async Task OpenCreateProjectDialog()
    {
        await DialogService.OpenAsync<CreateProjectDialog>(
            "Create Project",
            new Dictionary<string, object>(),
            new DialogOptions
                {
                    Width = "600px", 
                    Height = "500px",
                    CloseDialogOnEsc = true,
                    CloseDialogOnOverlayClick = true
                }
        );
        
        await LoadData();
    }
    
    private async Task OpenEditProjectDialog(ProjectModel project)
    {
        await DialogService.OpenAsync<EditProjectDialog>(
            "Edit Project",
            new Dictionary<string, object>
            {
                { "Project", project }
            },
            new DialogOptions
                {
                    Width = "600px", 
                    Height = "500px",
                    CloseDialogOnEsc = true,
                    CloseDialogOnOverlayClick = true
                }
        );
        
        await LoadData();
    }
    
    private async Task ConfirmDelete(ProjectModel project)
    {
        var confirmed = await DialogService.Confirm($"Delete \"{project.Name}\" permanently?", "Delete project",
            new ConfirmOptions
            {
                OkButtonText = "Delete",
                CancelButtonText = "Cancel",
                CloseDialogOnEsc = true,
                CloseDialogOnOverlayClick = true
            });
        if (confirmed is not true) return;

        try
        {
            var success = await ProjectService.DeleteProjectAsync(project.ProjectId);
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Project deleted.", duration: 4000);
                await LoadData();
                if (_grid != null) await _grid.Reload();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Delete failed.", duration: 4000);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, $"Delete failed, failure message: {ex.Message}", duration: 6000);
            Console.Error.WriteLine(ex);
        }
    }
}