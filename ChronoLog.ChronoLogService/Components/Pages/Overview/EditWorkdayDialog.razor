@using ChronoLog.Core.Interfaces
@using ChronoLog.Core.Models
@using ChronoLog.Core.Models.DisplayObjects
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject IWorktimeService WorktimeService

<RadzenTemplateForm TItem="WorkdayViewModel" Data="@Workday" Submit=@OnSubmit>
    <RadzenStack Gap="1rem">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap">
            <RadzenLabel Text="Workday Type" Component="WorkdayTypeDropdown"/>
            <RadzenDropDown @bind-Value="@Workday.Type" Data="@WorkdayTypes" Name="WorkdayTypeDropdown"/>
        </RadzenStack>

        <RadzenCardGroup Responsive="true">
            <!-- Worktime edit -->
            <RadzenCard Variant="Variant.Flat">
                <RadzenDataGrid @ref="@_worktimeGrid"
                                Data="@_worktimes"
                                TItem="WorktimeModel"
                                AllowAlternatingRows="false"
                                AllowFiltering="true"
                                AllowPaging="true"
                                AllowSorting="true"
                                PageSize="15"
                                EditMode="DataGridEditMode.Single"
                                RowUpdate="@OnUpdateRow"
                                RowCreate="@OnCreateRow"
                                Sort="@ClearPendingInsertions"
                                Page="@ClearPendingInsertions"
                                Filter="@ClearPendingInsertions">
                    <HeaderTemplate>
                        <RadzenButton ButtonStyle="ButtonStyle.Success" Icon="add_circle" Text="Add Worktime" Click="@InsertRow" Disabled="@(_worktimesToInsert.Any())"/>
                    </HeaderTemplate>
                    <Columns>
                        <RadzenDataGridColumn TItem="WorktimeModel" Property="StartTime" Title="StartTime" Width="150px">
                            <EditTemplate Context="worktime">
                                <RadzenTimeSpanPicker Value="@(worktime.StartTime.ToTimeSpan())"
                                                      ValueChanged="@( (TimeSpan ts) => worktime.StartTime = TimeOnly.FromTimeSpan(ts) )"
                                                      Min="@TimeSpan.Zero"
                                                      Max="@TimeSpan.FromMinutes(1439)"/>
                            </EditTemplate>
                            <Template Context="worktime">
                                @worktime.StartTime.ToString("HH':'mm':'ss")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="WorktimeModel" Property="EndTime" Title="EndTime" Width="150px">
                            <EditTemplate Context="worktime">
                                <RadzenTimeSpanPicker Value="@(worktime.EndTime.HasValue ? worktime.EndTime.Value.ToTimeSpan() : (TimeSpan?)null)"
                                                      ValueChanged="@( (TimeSpan? ts) => worktime.EndTime = ts.HasValue ? TimeOnly.FromTimeSpan(ts.Value) : (TimeOnly?)null )"
                                                      Min="@TimeSpan.Zero"
                                                      Max="@TimeSpan.FromMinutes(1439)"/>
                            </EditTemplate>
                            <Template Context="worktime">
                                @worktime.EndTime?.ToString("HH':'mm':'ss")
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn Context="worktime" Filterable="false" Sortable="false" TextAlign="TextAlign.Right" Frozen="true" FrozenPosition="FrozenColumnPosition.Right">
                            <Template Context="worktime">
                                <RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(_ => EditRow(worktime))" @onclick:stopPropagation="true" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Medium" Shade="Shade.Lighter" class="rz-my-1 rz-ms-1" Click="@(_ => DeleteRow(worktime))" @onclick:stopPropagation="true" />
                            </Template>
                            <EditTemplate Context="worktime">
                                <RadzenButton Icon="check" ButtonStyle="ButtonStyle.Success" Variant="Variant.Flat" Size="ButtonSize.Medium" Click="@(_ => SaveRow(worktime))" aria-label="Save"/>
                                <RadzenButton Icon="close" ButtonStyle="ButtonStyle.Light" Variant="Variant.Flat" Size="ButtonSize.Medium" class="rz-my-1 rz-ms-1" Click="@(_ => CancelEdit(worktime))" aria-label="Cancel"/>
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Size="ButtonSize.Medium" Shade="Shade.Lighter" class="rz-my-1 rz-ms-1" Click="@(_ => DeleteRow(worktime))" aria-label="Delete" />
                            </EditTemplate>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            </RadzenCard>

            <!-- Project edit -->
            <RadzenCard Variant="Variant.Flat">

            </RadzenCard>
        </RadzenCardGroup>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter]
    public required WorkdayViewModel Workday { get; set; }

    private static readonly IEnumerable<string> WorkdayTypes = Enum.GetNames(typeof(WorkdayType));
    private RadzenDataGrid<WorktimeModel> _worktimeGrid = new();
    private List<WorktimeModel> _worktimes = [];
    private readonly List<WorktimeModel> _worktimesToInsert = [];

    protected override void OnParametersSet()
    {
        _worktimes = Workday.Worktimes.ToList();
    }

    private void ClearPendingInsertions()
    {
        _worktimesToInsert.Clear();
    }

    private void RemovePendingInsertion(WorktimeModel worktime)
    {
        _worktimesToInsert.Remove(worktime);
    }

    private async Task EditRow(WorktimeModel worktime)
    {
        if (!_worktimeGrid.IsValid) return;
        
        ClearPendingInsertions();
        await _worktimeGrid.EditRow(worktime);
    }

    private async Task OnUpdateRow(WorktimeModel worktime)
    {
        RemovePendingInsertion(worktime);
        if (!await WorktimeService.UpdateWorktimeAsync(worktime))
        {
            _worktimeGrid.CancelEditRow(worktime);
            NotificationService.Notify(NotificationSeverity.Error, "Update of worktime failed.", duration: 4000);
        }
    }

    private async Task SaveRow(WorktimeModel worktime)
    {
        await _worktimeGrid.UpdateRow(worktime);
    }

    private void CancelEdit(WorktimeModel worktime)
    {
        RemovePendingInsertion(worktime);
        _worktimeGrid.CancelEditRow(worktime);
    }

    private async Task DeleteRow(WorktimeModel worktime)
    {
        RemovePendingInsertion(worktime);

        if (_worktimes.Contains(worktime))
        {
            if(!await WorktimeService.DeleteWorktimeAsync(worktime.WorktimeId))
            {
                NotificationService.Notify(NotificationSeverity.Error, "Deletion of worktime failed.", duration: 4000);
                return;
            }
            _worktimes.Remove(worktime);
        }
        else
        {
            _worktimeGrid.CancelEditRow(worktime);
        }

        await _worktimeGrid.Reload();
    }

    private async Task InsertRow()
    {
        if (!_worktimeGrid.IsValid) return;
        
        ClearPendingInsertions();
        var newWorktime = new WorktimeModel();
        try
        {
            _worktimesToInsert.Add(newWorktime);
            await _worktimeGrid.InsertRow(newWorktime);
        }
        catch
        {
            _worktimesToInsert.Remove(newWorktime);
            NotificationService.Notify(NotificationSeverity.Error, "Insertion of worktime failed.", duration: 4000);
        }
    }

    private async Task OnCreateRow(WorktimeModel worktime)
    {
        worktime.WorkdayId = Workday.WorkdayId;
        var createdWorktimeId = await WorktimeService.CreateWorktimeAsync(worktime);
        var createdWorktime = await WorktimeService.GetWorktimeByIdAsync(createdWorktimeId);

        if (createdWorktime != null) _worktimes.Add(createdWorktime);
        _worktimesToInsert.Remove(worktime);
        await _worktimeGrid.Reload();
    }

    void OnSubmit(WorkdayViewModel model)
    {
        DialogService.Close(model);
    }
}
