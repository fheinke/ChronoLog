@page "/"
@inject DialogService DialogService
@inject NavigationManager NavigationManager
@using ChronoLog.Core.Interfaces
@using ChronoLog.Core.Models
@using ChronoLog.Core.Models.DisplayObjects
@using PublicHoliday
@inject IWorkdayService WorkdayService
@inject IEmployeeContextService EmployeeContextService

<PageTitle>Overview</PageTitle>

<div style="display: flex; flex-direction: column; height: 100%; gap: 10px;">
    <RadzenScheduler @ref="@_scheduler"
                     SlotRender="@OnSlotRender"
                     SelectedIndex="1"
                     Style="height: 760px;"
                     TItem="WorkdayViewModel"
                     Data="@_workdays"
                     StartProperty="Start"
                     EndProperty="End"
                     TextProperty="TypeText"
                     SlotSelect="@OnSlotSelect"
                     AppointmentSelect="@OnAppointmentSelect"
                     AppointmentRender="@OnAppointmentRender"
                     DaySelect="@OnDaySelect">
        <RadzenYearView/>
        <RadzenMonthView/>
        <RadzenWeekView StartTime="@(new TimeSpan(0, 0, 0))" EndTime="@(new TimeSpan(24, 0, 0))"/>
        <RadzenDayView StartTime="@(new TimeSpan(0, 0, 0))" EndTime="@(new TimeSpan(24, 0, 0))"/>
    </RadzenScheduler>
</div>

@code {
    private RadzenScheduler<WorkdayViewModel>? _scheduler;
    private List<WorkdayViewModel>? _workdays;
    private GermanPublicHoliday _holidays = new() { State = GermanPublicHoliday.States.ALL };
    private EmployeeModel _employee = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _workdays = (await WorkdayService.GetWorkdaysAsync()).ToList();
        _employee = await EmployeeContextService.GetOrCreateCurrentEmployeeAsync();
        _holidays = new GermanPublicHoliday { State = ParseProvinceToState(_employee.Province) };
        StateHasChanged();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var dateString = query["date"];

            if (!string.IsNullOrEmpty(dateString) && DateTime.TryParse(dateString, out var date))
            {
                await OpenEditDialogForDate(date);
                NavigationManager.NavigateTo("/", false);
            }
        }
    }

    private static void OnDaySelect(SchedulerDaySelectEventArgs args)
    {
    }

    private void OnSlotRender(SchedulerSlotRenderEventArgs args)
    {
        var existingStyle = args.Attributes.TryGetValue("style", out var style) ? style?.ToString() ?? string.Empty : string.Empty;
        var styleBuilder = existingStyle.TrimEnd(';');
        
        var holidayNames = _holidays.PublicHolidayNames(args.Start.Year);
        var isHoliday = holidayNames.ContainsKey(args.Start.Date);

        // Dim non-working days (Saturday and Sunday)
        if (args.Start.DayOfWeek is DayOfWeek.Saturday or DayOfWeek.Sunday)
            styleBuilder = AppendStyle(styleBuilder, "background: var(--rz-base-300)");
        
        // Highlight holidays
        if (isHoliday)
            styleBuilder = AppendStyle(styleBuilder, "background: var(--rz-warning-lighter)");

        // Add holiday tooltip
        if (isHoliday && holidayNames.TryGetValue(args.Start.Date, out var holidayName))
        {
            args.Attributes["title"] = $"{holidayName} (Feiertag)";
        }

        switch (args.View.Text)
        {
            // Highlight today in year and month view
            case "Year" or "Month" when args.Start.Date == DateTime.Today:
            // Highlight working hours
            case "Week" or "Day" when args.Start.Hour is > 7 and < 16:
                styleBuilder = AppendStyle(styleBuilder, "background: var(--rz-primary-lighter)");
                break;
        }
        
        if (!string.IsNullOrWhiteSpace(styleBuilder))
        {
            args.Attributes["style"] = styleBuilder;
        }

        return;

        static string AppendStyle(string baseStyle, string newStyle)
        {
            if (string.IsNullOrWhiteSpace(baseStyle)) return newStyle;
            return baseStyle.TrimEnd() + ";" + newStyle;
        }
    }

    private static void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<WorkdayViewModel> args)
    {
        // Change background and text color based on WorkdayType
        var (bg, fg) = args.Data.Type switch
        {
            WorkdayType.Homeoffice => ("#1976d2", "white"),
            WorkdayType.Office => ("#d32f2f", "white"),
            WorkdayType.Gleitzeittag or WorkdayType.Urlaub => ("#8e24aa", "white"),
            WorkdayType.Krankheitstag => ("#fdd835", "black"),
            WorkdayType.Feiertag => ("#388e3c", "white"),
            _ => (null, "inherit")
        };

        // Keep existing styles and append new styles
        var existingStyle = args.Attributes.TryGetValue("style", out var style) ? style?.ToString() ?? string.Empty : string.Empty;
        var styleBuilder = existingStyle.TrimEnd(';');

        if (bg is not null)
        {
            if (!string.IsNullOrEmpty(styleBuilder))
            {
                styleBuilder += ";";
            }

            // Add important colors to override default styles
            styleBuilder += $"background-color: {bg} !important; border-color: {bg} !important; color: {fg} !important;";
        }

        args.Attributes["style"] = styleBuilder;
    }

    private async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        if (args.View.Text == "Year")
            return;

        if (args.Appointments.Any())
        {
            var appointmentArgs = new SchedulerAppointmentSelectEventArgs<WorkdayViewModel>
            {
                Start = args.Start,
                End = args.End,
                Data = (WorkdayViewModel)args.Appointments.First().Data
            };
            await OnAppointmentSelect(appointmentArgs);
            return;
        }

        WorkdayViewModel data = await DialogService.OpenAsync<EditWorkdayDialog>(
            $"Add Workday - {args.Start.Date.ToShortDateString()}",
            new Dictionary<string, object> { { "SelectedDate", args.Start.Date } },
            new DialogOptions
            {
                Width = "1500px",
                Height = "600px",
                CloseDialogOnEsc = true,
                CloseDialogOnOverlayClick = true
            });

        if (data is not null)
        {
            _workdays?.Add(data);
            await _scheduler?.Reload()!;
        }

        await LoadData();
    }

    private async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<WorkdayViewModel> args)
    {
        var data = await DialogService.OpenAsync<EditWorkdayDialog>(
            $"Edit Workday - {args.Start.Date.ToShortDateString()}",
            new Dictionary<string, object> { { "Workday", args.Data } },
            new DialogOptions
            {
                Width = "1500px",
                Height = "600px",
                CloseDialogOnEsc = true,
                CloseDialogOnOverlayClick = true
            });

        if (data is not null)
        {
            args.Data.EmployeeId = data.EmployeeId;
            args.Data.Date = data.Date;
            args.Data.Type = data.Type;
            args.Data.Worktimes = data.Worktimes;
            args.Data.Projecttimes = data.Projecttimes;
        }

        await _scheduler?.Reload()!;
        await LoadData();
    }
    
    private async Task OpenEditDialogForDate(DateTime date)
    {
        var workday = _workdays?.FirstOrDefault(w => w.Date.Date == date.Date);

        if (workday != null)
        {
            var appointmentArgs = new SchedulerAppointmentSelectEventArgs<WorkdayViewModel>
            {
                Start = date,
                End = date.AddDays(1),
                Data = workday
            };
            await OnAppointmentSelect(appointmentArgs);
        }
        else
        {
            var slotArgs = new SchedulerSlotSelectEventArgs
            {
                Start = date,
                End = date.AddDays(1)
            };
            await OnSlotSelect(slotArgs);
        }
    }
    
    private static GermanPublicHoliday.States ParseProvinceToState(GermanProvince province)
    {
        return province switch
        {
            GermanProvince.BW => GermanPublicHoliday.States.BW,
            GermanProvince.BY => GermanPublicHoliday.States.BY,
            GermanProvince.BE => GermanPublicHoliday.States.BE,
            GermanProvince.BB => GermanPublicHoliday.States.BB,
            GermanProvince.HB => GermanPublicHoliday.States.HB,
            GermanProvince.HH => GermanPublicHoliday.States.HH,
            GermanProvince.HE => GermanPublicHoliday.States.HE,
            GermanProvince.MV => GermanPublicHoliday.States.MV,
            GermanProvince.NI => GermanPublicHoliday.States.NI,
            GermanProvince.NW => GermanPublicHoliday.States.NW,
            GermanProvince.RP => GermanPublicHoliday.States.RP,
            GermanProvince.SL => GermanPublicHoliday.States.SL,
            GermanProvince.SN => GermanPublicHoliday.States.SN,
            GermanProvince.ST => GermanPublicHoliday.States.ST,
            GermanProvince.SH => GermanPublicHoliday.States.SH,
            GermanProvince.TH => GermanPublicHoliday.States.TH,
            _ => GermanPublicHoliday.States.ALL
        };
    }

}