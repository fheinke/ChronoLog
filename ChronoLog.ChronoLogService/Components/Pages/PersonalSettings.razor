@page "/personalsettings"
@using ChronoLog.Core.Interfaces
@using ChronoLog.Core.Models
@using ChronoLog.Core.Models.DisplayObjects
@using ChronoLog.Core.Models.HelperObjects
@inject NotificationService NotificationService
@inject IEmployeeContextService EmployeeContextService

<PageTitle>Personal Settings</PageTitle>

<RadzenStack Gap="1.5rem" Style="max-width: 800px; margin: 0 auto;">
    <RadzenRow AlignItems="AlignItems.Center" Gap="1rem">
        <RadzenColumn>
            <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1">Personal Settings</RadzenText>
        </RadzenColumn>
    </RadzenRow>

    <RadzenCard Style="padding: 2rem;">
        <RadzenStack Gap="1.5rem">
            <RadzenRow>
                <RadzenColumn>
                    <RadzenText TextStyle="TextStyle.H6" Style="margin-bottom: 1rem;">
                        <RadzenIcon Icon="person" Style="vertical-align: middle; margin-right: 0.5rem;"/>
                        Personal Information
                    </RadzenText>
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Province" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenDropDown @bind-Value="@_selectedProvince"
                                            Data="@_provinces"
                                            TextProperty="Name"
                                            ValueProperty="Value"
                                            Style="width: 100%;"/>
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">
                                Select your province for accurate public holiday calculations
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Vacationdays per year" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenNumeric Name="VacationDaysPerYear" @bind-Value="@_employee.VacationDaysPerYear" 
                                           Min="0" Max="365" ShowUpDown="true"/>
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">
                                Number of vacation days you have per year
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Daily Working Time (Hours)" Variant="Variant.Outlined" Style="width: 100%;">
                        <ChildContent>
                            <RadzenNumeric Name="DailyWorkingTimeInHours" @bind-Value="@_employee.DailyWorkingTimeInHours" 
                                           Min="0" Max="24" Step="0.25" ShowUpDown="true"/>
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">
                                Your standard daily working time in hours
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>

            <RadzenRow Style="margin-top: 1rem;">
                <RadzenColumn>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.End">
                        <RadzenButton Text="Save Changes" 
                                      Icon="save" 
                                      Click="@SaveChanges" 
                                      ButtonStyle="ButtonStyle.Primary"
                                      Size="ButtonSize.Large"/>
                    </RadzenStack>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private EmployeeModel _employee = new();
    private GermanProvince _selectedProvince;
    
    private readonly List<ProvinceItemModel> _provinces =
    [
        new() { Name = "National", Value = GermanProvince.ALL },
        new() { Name = "Baden-Württemberg", Value = GermanProvince.BW },
        new() { Name = "Bayern", Value = GermanProvince.BY },
        new() { Name = "Berlin", Value = GermanProvince.BE },
        new() { Name = "Brandenburg", Value = GermanProvince.BB },
        new() { Name = "Bremen", Value = GermanProvince.HB },
        new() { Name = "Hamburg", Value = GermanProvince.HH },
        new() { Name = "Hessen", Value = GermanProvince.HE },
        new() { Name = "Mecklenburg-Vorpommern", Value = GermanProvince.MV },
        new() { Name = "Niedersachsen", Value = GermanProvince.NI },
        new() { Name = "Nordrhein-Westfalen", Value = GermanProvince.NW },
        new() { Name = "Rheinland-Pfalz", Value = GermanProvince.RP },
        new() { Name = "Saarland", Value = GermanProvince.SL },
        new() { Name = "Sachsen", Value = GermanProvince.SN },
        new() { Name = "Sachsen-Anhalt", Value = GermanProvince.ST },
        new() { Name = "Schleswig-Holstein", Value = GermanProvince.SH },
        new() { Name = "Thüringen", Value = GermanProvince.TH }
    ];

    protected override async Task OnInitializedAsync()
    {
        _employee = await EmployeeContextService.GetOrCreateCurrentEmployeeAsync();
        _selectedProvince = _employee.Province;
    }

    private async Task SaveChanges()
    {
        _employee.Province = _selectedProvince;
        if (await EmployeeContextService.UpdateEmployeeAsync(_employee))
            NotificationService.Notify(NotificationSeverity.Success, "Personal settings updated successfully.", duration: 4000);
        else
            NotificationService.Notify(NotificationSeverity.Error, "Update of personal settings failed.", duration: 4000);
    }
}
