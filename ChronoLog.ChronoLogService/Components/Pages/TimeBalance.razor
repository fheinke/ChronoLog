@page "/timebalance"
@using ChronoLog.Core.Interfaces
@using ChronoLog.Core.Models
@using ChronoLog.Core.Models.DisplayObjects
@inject IEmployeeContextService EmployeeContextService
@inject IWorkdayService WorkdayService

<PageTitle>Time Balance</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1">Personal Time Balance</RadzenText>

    <!-- Overview Cards -->
    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Vacation</RadzenText>
                    <RadzenText TextStyle="TextStyle.H3" Style="color: var(--rz-primary)">
                        @(_absenceDays.Count(a => a.AbsenceTypes.Split(", ").Contains(nameof(ReducingWorkdayType.Urlaub)))) / @_vacationDaysPerYear
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Remaining: @RemainingVacationDays Days</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Overtime</RadzenText>
                    <RadzenText TextStyle="TextStyle.H3" Style="@GetOvertimeColor()">
                        @_totalOvertime.ToString("F2") h
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Hours collected</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Absence Details -->
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.H6" Style="margin-bottom: 1rem">Absence overview</RadzenText>
        <RadzenDataGrid Data="@_absenceDays" TItem="AbsenceEntryModel" AllowPaging="true" PageSize="10">
            <Columns>
                <RadzenDataGridColumn TItem="AbsenceEntryModel" Property="StartDate" Title="First Day">
                    <Template Context="data">
                        @data.StartDate.ToShortDateString()
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="AbsenceEntryModel" Property="EndDate" Title="Last Day">
                    <Template Context="data">
                        @data.EndDate.ToShortDateString()
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="AbsenceEntryModel" Property="AbsenceTypes" Title="Type"/>
                <RadzenDataGridColumn TItem="AbsenceEntryModel" Property="DurationInDays" Title="Days"/>
            </Columns>
        </RadzenDataGrid>
    </RadzenCard>
</RadzenStack>

@code {
    private EmployeeModel? _currentEmployee;

    private List<AbsenceEntryModel> _absenceDays = [];
    private int _vacationDaysPerYear;
    private int RemainingVacationDays => _vacationDaysPerYear - _absenceDays.Count(a => a.AbsenceTypes.Split(", ").Contains(nameof(ReducingWorkdayType.Urlaub)));
    private double _totalOvertime;

    protected override async Task OnInitializedAsync()
    {
        _currentEmployee = await EmployeeContextService.GetOrCreateCurrentEmployeeAsync();
        _vacationDaysPerYear = _currentEmployee.VacationDaysPerYear;
        _absenceDays = await EmployeeContextService.GetEmployeeAbsenceDaysAsync(_currentEmployee.EmployeeId, DateTime.UtcNow.Year);
        _totalOvertime = await WorkdayService.GetTotalOvertimeAsync();
    }
    
    private string GetOvertimeColor() => _totalOvertime >= 0 ? "color: var(--rz-success)" : "color: var(--rz-danger)";
}