@page "/evaluation"
@using System.Globalization
@using ChronoLog.Core.Interfaces
@using ChronoLog.Core.Models
@using ChronoLog.Core.Models.DisplayObjects
@inject IJSRuntime JsRuntime
@inject NotificationService NotificationService
@inject IWorkdayService WorkdayService
@inject IWorktimeService WorktimeService
@inject IProjectService ProjectService
@inject IProjecttimeService ProjecttimeService

<PageTitle>Evaluation</PageTitle>

<RadzenStack Orientation="Orientation.Vertical" Gap="10px">
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.Center"
                 AlignItems="AlignItems.Center" Gap="0.5rem" class="rz-p-3">
        <RadzenLabel Text="Select Week" Component="DatePickerYearWeek"/>
        <RadzenDatePicker @bind-Value="@_selectedDate" ShowButton="false" DateFormat="dd/MM/yyyy"
                          CurrentDateChanged="@OnCurrentDateChanged" Name="DatePickerYearWeek">
            <FooterTemplate>
                <RadzenButton Click="@(_ => OnCurrentDateChanged(DateTime.Now))" Text="Today"
                              Style="width: 100%;" class="rz-my-4"/>
            </FooterTemplate>
        </RadzenDatePicker>
        <RadzenButton Icon="chevron_left" ButtonStyle="ButtonStyle.Light" Click="@PrevWeek"
                      Style="margin-left:0.5rem;"/>
        <RadzenButton Icon="chevron_right" ButtonStyle="ButtonStyle.Light" Click="@NextWeek"/>
        <div style="display:flex; align-items:center; margin-left:1rem;">
            <strong>Week @CultureInfo.CurrentCulture.Calendar.GetWeekOfYear(_selectedDate, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday):</strong>&nbsp;
            <span>@_dateRangeStart.ToString("dd.MM.yyyy") - @_dateRangeEnd.ToString("dd.MM.yyyy")</span>
        </div>
    </RadzenStack>
    
    @if (_missingWorktimeDates.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning"
                     Variant="Variant.Flat"
                     Shade="Shade.Lighter"
                     class="rz-my-4">
            <strong>Warning:</strong> There are missing worktime entries for the following dates:
            <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                @foreach (var date in _missingWorktimeDates)
                {
                    <li>
                        <RadzenLink Path="@GetWorkdayEditPath(date)" Text="@date.ToString("dd.MM.yyyy")" Style="margin-left:0.5rem;"/>
                    </li>
                }
            </ul>
            For accurate evaluation, please ensure all worktime entries are recorded.
        </RadzenAlert>
    }
    
    <RadzenTabs>
        <Tabs>
            <RadzenTabsItem Text="Daily SAP">
                <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" Gap="0.5rem"
                             class="rz-p-4 rz-mb-6 rz-border-radius-1"
                             Style="border: var(--rz-grid-cell-border, 1px solid rgba(0,0,0,0.12));">
                    <RadzenLabel Text="Total Booked Working Time:"/>
                    <RadzenBadge Text="@($"{_totalWorkingHours.TotalHours:F2}h")"/>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" Gap="0.5rem"
                             class="rz-p-4 rz-mb-6 rz-border-radius-1"
                             Style="border: var(--rz-grid-cell-border, 1px solid rgba(0,0,0,0.12));">
                    <RadzenLabel Text="Project Times for this Week:"/>
                    @if (_projecttimes.Count > 0)
                    {
                        <RadzenDataGrid Data="@_projecttimes"
                                        TItem="ProjecttimeModel"
                                        RowHover="true"
                                        ShowPagingSummary="true"
                                        PageSize="15"
                                        AllowPaging="true"
                                        AllowSorting="true"
                                        AllowFiltering="true"
                                        Style="width:100%;">
                            <Columns>
                                <RadzenDataGridColumn TItem="ProjecttimeModel" Title="Date" Sortable="true">
                                    <Template Context="item">
                                        @{
                                            var workday = _workdays.FirstOrDefault(w => w.WorkdayId == item.WorkdayId);
                                        }
                                        @workday?.Date.ToString("dd.MM.yyyy")
                                    </Template>
                                </RadzenDataGridColumn>

                                <RadzenDataGridColumn TItem="ProjecttimeModel" Property="Name" Title="Project Name">
                                    <Template Context="item">
                                        <div @onclick="@(() => CopyToClipboard(_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.Name ?? string.Empty))"
                                             style="cursor: pointer;"
                                             title="Click to copy">
                                            @_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.Name
                                        </div>
                                    </Template>
                                </RadzenDataGridColumn>
                                
                                <RadzenDataGridColumn TItem="ProjecttimeModel" Property="Name" Title="Response Object">
                                    <Template Context="item">
                                        <div @onclick="@(() => CopyToClipboard(_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.ResponseObject ?? string.Empty))"
                                             style="cursor: pointer;"
                                             title="Click to copy">
                                            @_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.ResponseObject
                                        </div>
                                    </Template>
                                </RadzenDataGridColumn>
                                
                                <RadzenDataGridColumn TItem="ProjecttimeModel" Property="TimeSpent"
                                                      Title="Time Spent (h)">
                                    <Template Context="item">
                                        <div @onclick="@(() => CopyToClipboard(item.TimeSpent.TotalHours.ToString("F2")))"
                                             style="cursor: pointer;"
                                             title="Click to copy">
                                            @item.TimeSpent.TotalHours.ToString("F2")
                                        </div>
                                    </Template>
                                    <FooterTemplate>
                                        Total: <strong>@GetTotalTimeSpent().ToString("F2") h</strong>
                                    </FooterTemplate>
                                </RadzenDataGridColumn>
                                
                                <RadzenDataGridColumn TItem="ProjecttimeModel" Title="Response Text">
                                    <Template Context="item">
                                        @if (!string.IsNullOrEmpty(item.ResponseText))
                                        {
                                            <div @onclick="@(() => CopyToClipboard(item.ResponseText))"
                                                 style="cursor: pointer;"
                                                 title="Click to copy">
                                                <span
                                                    style="font-weight: bold; color: var(--rz-primary);">@item.ResponseText</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div @onclick="@(() => CopyToClipboard(_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.DefaultResponseText ?? string.Empty))"
                                                 style="cursor: pointer;"
                                                 title="Click to copy">
                                                <span
                                                    style="font-style: italic; color: var(--rz-text-secondary-color);">@_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.DefaultResponseText</span>
                                            </div>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>

                            </Columns>
                        </RadzenDataGrid>
                    }
                    else
                    {
                        <RadzenLabel Text="No project times recorded for this week." Style="font-style: italic;"/>
                    }
                </RadzenStack>
            </RadzenTabsItem>
            
            <RadzenTabsItem Text="Weekly SAP" Selected="true">
                <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" Gap="0.5rem"
                             class="rz-p-4 rz-mb-6 rz-border-radius-1"
                             Style="border: var(--rz-grid-cell-border, 1px solid rgba(0,0,0,0.12));">
                    <RadzenLabel Text="Total Booked Working Time:"/>
                    <RadzenBadge Text="@($"{_totalWorkingHours.TotalHours:F2}h")"/>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" Gap="0.5rem"
                             class="rz-p-4 rz-mb-6 rz-border-radius-1"
                             Style="border: var(--rz-grid-cell-border, 1px solid rgba(0,0,0,0.12));">
                    <RadzenLabel Text="Aggregated Project Times for this Week:"/>
                    @if (_projecttimes.Count > 0)
                    {
                        <RadzenDataGrid Data="@AggregateProjecttimes()"
                                        TItem="ProjecttimeModel"
                                        RowHover="true"
                                        ShowPagingSummary="true"
                                        PageSize="15"
                                        AllowPaging="true"
                                        AllowSorting="true"
                                        AllowFiltering="true"
                                        Style="width:100%;">
                            <Columns>
                                <RadzenDataGridColumn TItem="ProjecttimeModel" Property="Name" Title="Project Name">
                                    <Template Context="item">
                                        <div @onclick="@(() => CopyToClipboard(_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.Name ?? string.Empty))"
                                             style="cursor: pointer;"
                                             title="Click to copy">
                                            @_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.Name
                                        </div>
                                    </Template>
                                </RadzenDataGridColumn>
                                
                                <RadzenDataGridColumn TItem="ProjecttimeModel" Property="Name" Title="Response Object">
                                    <Template Context="item">
                                        <div @onclick="@(() => CopyToClipboard(_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.ResponseObject ?? string.Empty))"
                                             style="cursor: pointer;"
                                             title="Click to copy">
                                            @_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.ResponseObject
                                        </div>
                                    </Template>
                                </RadzenDataGridColumn>
                                
                                <RadzenDataGridColumn TItem="ProjecttimeModel" Property="TimeSpent"
                                                      Title="Time Spent (h)">
                                    <Template Context="item">
                                        <div @onclick="@(() => CopyToClipboard(item.TimeSpent.TotalHours.ToString("F2")))"
                                             style="cursor: pointer;"
                                             title="Click to copy">
                                            @item.TimeSpent.TotalHours.ToString("F2")
                                        </div>
                                    </Template>
                                    <FooterTemplate>
                                        Total: <strong>@GetAggregatedTotalTimeSpent().ToString("F2") h</strong>
                                    </FooterTemplate>
                                </RadzenDataGridColumn>
                                
                                <RadzenDataGridColumn TItem="ProjecttimeModel" Title="Response Text">
                                    <Template Context="item">
                                        @if (!string.IsNullOrEmpty(item.ResponseText))
                                        {
                                            <div @onclick="@(() => CopyToClipboard(item.ResponseText))"
                                                 style="cursor: pointer;"
                                                 title="Click to copy">
                                                <span
                                                    style="font-weight: bold; color: var(--rz-primary);">@item.ResponseText</span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div @onclick="@(() => CopyToClipboard(_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.DefaultResponseText ?? string.Empty))"
                                                 style="cursor: pointer;"
                                                 title="Click to copy">
                                                <span
                                                    style="font-style: italic; color: var(--rz-text-secondary-color);">@_projects.FirstOrDefault(p => p.ProjectId == item.ProjectId)?.DefaultResponseText</span>
                                            </div>
                                        }
                                    </Template>
                                </RadzenDataGridColumn>

                            </Columns>
                        </RadzenDataGrid>
                    }
                    else
                    {
                        <RadzenLabel Text="No project times recorded for this week." Style="font-style: italic;"/>
                    }
                </RadzenStack>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
</RadzenStack>

@code {
    private DateTime _selectedDate = GetStartOfWeek(DateTime.Now);
    private DateTime _dateRangeStart;
    private DateTime _dateRangeEnd;

    private const double DailyWorkingHours = 8.0;
    private List<string>? _reducingWorkdayTypes;
    private TimeSpan _totalWorkingHours;

    private ProjectModel? _defaultProject;
    private List<ProjectModel> _projects = [];
    private List<WorkdayViewModel> _workdays = [];
    private List<ProjecttimeModel> _projecttimes = [];
    private List<DateTime> _missingWorktimeDates = [];

    protected override async Task OnInitializedAsync()
    {
        SetWeekFromDate(_selectedDate);
        _projects = await ProjectService.GetProjectsAsync();
        _defaultProject = _projects.FirstOrDefault(p => p.IsDefault);
        _reducingWorkdayTypes = GetReducingWorkdayTypeStrings();
        await UpdateWorkdayDataAsync();
    }

    private async Task UpdateWorkdayDataAsync()
    {
        _workdays = await WorkdayService.GetWorkdaysAsync(_dateRangeStart, _dateRangeEnd);
        _projecttimes = await ProjecttimeService.GetProjecttimesAsync(_dateRangeStart, _dateRangeEnd);
        _missingWorktimeDates.Clear();
        
        foreach (var workday in _workdays)
        {
            if (_reducingWorkdayTypes!.Contains(workday.TypeText))
                continue;

            var actualWorktime = await WorkdayService.GetTotalWorktimeAsync(workday.WorkdayId);
            var actualWorktimeHours = actualWorktime.TotalHours == 0 ? DailyWorkingHours : actualWorktime.TotalHours;
            if (actualWorktime == TimeSpan.Zero)
                _missingWorktimeDates.Add(workday.Date);

            var totalDailyProjecttime = _projecttimes
                .Where(pt => pt.WorkdayId == workday.WorkdayId)
                .Sum(pt => pt.TimeSpent.TotalHours);
            
            if (totalDailyProjecttime >= actualWorktimeHours)
                continue;
            
            var defaultProjecttime = new ProjecttimeModel
            {
                WorkdayId = workday.WorkdayId,
                ProjectId = _defaultProject?.ProjectId ?? Guid.Empty,
                TimeSpent = TimeSpan.FromHours(actualWorktimeHours - totalDailyProjecttime)
            };
            _projecttimes.Add(defaultProjecttime);
        }

        // Dictionary Lookups for better performance during sorting
        var workdayLookup = _workdays.ToDictionary(w => w.WorkdayId, w => w.Date);
        var projectLookup = _projects.ToDictionary(p => p.ProjectId, p => p.Name);

        _projecttimes = _projecttimes
            .OrderBy(pt => workdayLookup.TryGetValue(pt.WorkdayId, out var date) ? date : DateTime.MaxValue)
            .ThenBy(pt => projectLookup.TryGetValue(pt.ProjectId, out var name) ? name : string.Empty)
            .ToList();
        _missingWorktimeDates = _missingWorktimeDates.Distinct().OrderBy(d => d).ToList();

        _totalWorkingHours = await GetTotalWorkingHours();
        StateHasChanged();
    }

    private async Task OnCurrentDateChanged(DateTime date)
    {
        _selectedDate = new DateTime(date.Year, date.Month, date.Day);
        SetWeekFromDate(_selectedDate);
        await UpdateWorkdayDataAsync();
    }

    private void SetWeekFromDate(DateTime date)
    {
        _dateRangeStart = GetStartOfWeek(date);
        _dateRangeEnd = _dateRangeStart.AddDays(6).Date;
    }

    private static DateTime GetStartOfWeek(DateTime date)
    {
        var diff = (7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7;
        return date.Date.AddDays(-diff);
    }

    private async Task PrevWeek()
    {
        _selectedDate = _dateRangeStart.AddDays(-7);
        SetWeekFromDate(_selectedDate);
        await UpdateWorkdayDataAsync();
    }

    private async Task NextWeek()
    {
        _selectedDate = _dateRangeStart.AddDays(7);
        SetWeekFromDate(_selectedDate);
        await UpdateWorkdayDataAsync();
    }
    
    private static List<string> GetReducingWorkdayTypeStrings()
    {
        return Enum.GetValues<ReducingWorkdayType>()
            .Select(x => x.ToString())
            .ToList();
    }

    private async Task<TimeSpan> GetTotalWorkingHours()
    {
        var totalHours = await WorktimeService.GetTotalWorktimeAsync(_dateRangeStart, _dateRangeEnd);
        return totalHours ?? TimeSpan.Zero;
    }
    
    private static string GetWorkdayEditPath(DateTime date)
    {
        return $"/?date={date:yyyy-MM-dd}";
    }

    // I want to aggregate the projecttimes by ProjectId and sum their TimeSpent if the ResponseText is the same or empty.
    private List<ProjecttimeModel> AggregateProjecttimes()
    {
        var aggregated = new Dictionary<(Guid ProjectId, string ResponseText), ProjecttimeModel>();

        foreach (var pt in _projecttimes)
        {
            var key = (pt.ProjectId, pt.ResponseText ?? string.Empty);
            if (aggregated.ContainsKey(key))
            {
                aggregated[key].TimeSpent += pt.TimeSpent;
            }
            else
            {
                aggregated[key] = new ProjecttimeModel
                {
                    ProjectId = pt.ProjectId,
                    ResponseText = pt.ResponseText,
                    TimeSpent = pt.TimeSpent
                };
            }
        }

        return aggregated.Values.ToList();
    }

    private async Task CopyToClipboard(string text)
    {
        if (string.IsNullOrEmpty(text))
            return;
        
        await JsRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        NotificationService.Notify(NotificationSeverity.Info, $"Copied to clipboard: {text}", duration: 3000);
    }
    
    private double GetTotalTimeSpent()
    {
        return _projecttimes.Sum(pt => pt.TimeSpent.TotalHours);
    }
    
    private double GetAggregatedTotalTimeSpent()
    {
        return AggregateProjecttimes().Sum(pt => pt.TimeSpent.TotalHours);
    }
}