@page "/evaluation"
@using System.Globalization
@using ChronoLog.Core
@using ChronoLog.Core.Interfaces
@using ChronoLog.Core.Models.DisplayObjects
@inject IJSRuntime JsRuntime
@inject NotificationService NotificationService
@inject IEmployeeContextService EmployeeContextService
@inject IWorkdayService WorkdayService
@inject IWorktimeService WorktimeService
@inject IProjectService ProjectService
@inject IProjecttimeService ProjecttimeService

<PageTitle>Evaluation</PageTitle>

<RadzenStack Gap="1rem">
    <RadzenText TextStyle="TextStyle.H4" TagName="TagName.H1">Project Time Evaluation</RadzenText>

    <!-- Week Selector Card -->
    <RadzenCard>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween"
                     AlignItems="AlignItems.Center" Gap="1rem" Wrap="FlexWrap.Wrap">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenLabel Text="Select Week"/>
                <RadzenDatePicker @bind-Value="@_selectedDate" ShowButton="false" DateFormat="dd/MM/yyyy"
                                  CurrentDateChanged="@OnCurrentDateChanged">
                    <FooterTemplate>
                        <RadzenButton Click="@(_ => OnCurrentDateChanged(DateTime.Now))" Text="Today"
                                      Style="width: 100%;" class="rz-my-4"/>
                    </FooterTemplate>
                </RadzenDatePicker>
                <RadzenButton Icon="chevron_left" ButtonStyle="ButtonStyle.Light" Click="@PrevWeek"/>
                <RadzenButton Icon="chevron_right" ButtonStyle="ButtonStyle.Light" Click="@NextWeek"/>
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.H6">
                    Week @CultureInfo.CurrentCulture.Calendar.GetWeekOfYear(_selectedDate, CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday)
                </RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">
                    @_dateRangeStart.ToString("dd.MM.yyyy") - @_dateRangeEnd.ToString("dd.MM.yyyy")
                </RadzenText>
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>

    <!-- Warning Alert -->
    @if (_missingWorktimeDates.Any())
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat" Shade="Shade.Lighter">
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.H6">Missing Worktime Entries</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">
                    Please complete entries for the following dates for accurate evaluation:
                </RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Wrap="FlexWrap.Wrap" Gap="0.5rem">
                    @foreach (var date in _missingWorktimeDates)
                    {
                        <RadzenLink Path="@GetWorkdayEditPath(date)"
                                    Text="@date.ToString("dd.MM.yyyy")"
                                    Style="font-weight: 500;"/>
                    }
                </RadzenStack>
            </RadzenStack>
        </RadzenAlert>
    }

    <!-- Summary Cards -->
    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
            <RadzenCard>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Weekly Working Time</RadzenText>
                    <RadzenText TextStyle="TextStyle.H3" Style="color: var(--rz-primary)">
                        @_totalWorkingHours.TotalHours.ToString("F2") h
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Booked hours this week</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        
        <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
            <RadzenCard>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Office Days</RadzenText>
                    <RadzenText TextStyle="TextStyle.H3" Style="color: var(--rz-primary)">
                        @_officeDays
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Days in Office this week</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
            <RadzenCard>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Weekly Balance</RadzenText>
                    <RadzenText TextStyle="TextStyle.H3" Style="@GetOvertimeColor(_weeklyOvertime)">
                        @(_weeklyOvertime.TotalHours >= 0 ? "+" : "")@_weeklyOvertime.TotalHours.ToString("F2") h
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Overtime this week</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>

        <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
            <RadzenCard>
                <RadzenStack Gap="0.5rem">
                    <RadzenText TextStyle="TextStyle.H6">Monthly Balance</RadzenText>
                    <RadzenText TextStyle="TextStyle.H3" Style="@GetOvertimeColor(_monthlyOvertime)">
                        @(_monthlyOvertime.TotalHours >= 0 ? "+" : "")@_monthlyOvertime.TotalHours.ToString("F2") h
                    </RadzenText>
                    <RadzenText TextStyle="TextStyle.Body2">Overtime
                        in @_selectedDate.ToString("MMMM yyyy")</RadzenText>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>


    <!-- Tabs -->
    <RadzenCard Style="padding: 0;">
        <RadzenTabs>
            <Tabs>
                <RadzenTabsItem Text="Daily SAP">
                    <RadzenStack Gap="1rem" Style="padding: 1rem;">
                        <RadzenText TextStyle="TextStyle.H6">Daily Project Times</RadzenText>
                        @if (_projecttimes.Count > 0)
                        {
                            <ProjectTimeDataGrid Data="@_projecttimes"
                                                 ShowDateColumn="true"
                                                 DateColumnTemplate="@DateTemplate"
                                                 ProjectNameTemplate="@ProjectNameTemplate"
                                                 ResponseObjectTemplate="@ResponseObjectTemplate"
                                                 TimeSpentTemplate="@TimeSpentTemplate"
                                                 ResponseTextTemplate="@ResponseTextTemplate"
                                                 TotalTimeSpent="@GetTotalTimeSpent()"/>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                                No project times recorded for this week.
                            </RadzenAlert>
                        }
                    </RadzenStack>
                </RadzenTabsItem>

                <RadzenTabsItem Text="Weekly SAP" Selected="true">
                    <RadzenStack Gap="1rem" Style="padding: 1rem;">
                        <RadzenText TextStyle="TextStyle.H6">Aggregated Project Times</RadzenText>
                        @if (_projecttimes.Count > 0)
                        {
                            <ProjectTimeDataGrid Data="@AggregateProjecttimes()"
                                                 ShowDateColumn="false"
                                                 ProjectNameTemplate="@ProjectNameTemplate"
                                                 ResponseObjectTemplate="@ResponseObjectTemplate"
                                                 TimeSpentTemplate="@TimeSpentTemplate"
                                                 ResponseTextTemplate="@ResponseTextTemplate"
                                                 TotalTimeSpent="@GetAggregatedTotalTimeSpent()"/>
                        }
                        else
                        {
                            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
                                No project times recorded for this week.
                            </RadzenAlert>
                        }
                    </RadzenStack>
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>
    </RadzenCard>
</RadzenStack>

@code {
    private DateTime _selectedDate = GetStartOfWeek(DateTime.Now);
    private DateTime _dateRangeStart;
    private DateTime _dateRangeEnd;

    private double _dailyWorkingHours;
    private TimeSpan _totalWorkingHours;
    private TimeSpan _weeklyOvertime;
    private TimeSpan _monthlyOvertime;
    private int _officeDays;

    private ProjectModel? _defaultProject;
    private List<ProjectModel> _projects = [];
    private Dictionary<Guid, ProjectModel> _projectLookup = [];
    private List<WorkdayViewModel> _workdays = [];
    private List<ProjecttimeModel> _projecttimes = [];
    private List<DateTime> _missingWorktimeDates = [];

    private RenderFragment<ProjecttimeModel> DateTemplate => item => __builder =>
    {
        var workday = _workdays.FirstOrDefault(w => w.WorkdayId == item.WorkdayId);
        if (workday != null)
        {
            <text>@workday.Date.ToString("dd.MM.yyyy")</text>
        }
    };

    private RenderFragment<ProjecttimeModel> ProjectNameTemplate => item => __builder =>
    {
        <div
            @onclick="@(() => CopyToClipboard(_projectLookup.GetValueOrDefault(item.ProjectId)?.Name ?? string.Empty))"
            style="cursor: pointer;"
            title="Click to copy">
            @_projectLookup.GetValueOrDefault(item.ProjectId)?.Name
        </div>
    };

    private RenderFragment<ProjecttimeModel> ResponseObjectTemplate => item => __builder =>
    {
        <div
            @onclick="@(() => CopyToClipboard(_projectLookup.GetValueOrDefault(item.ProjectId)?.ResponseObject ?? string.Empty))"
            style="cursor: pointer;"
            title="Click to copy">
            @_projectLookup.GetValueOrDefault(item.ProjectId)?.ResponseObject
        </div>
    };

    private RenderFragment<ProjecttimeModel> TimeSpentTemplate => item => __builder =>
    {
        <div @onclick="@(() => CopyToClipboard(item.TimeSpent.TotalHours.ToString("F2")))"
             style="cursor: pointer;"
             title="Click to copy">
            @item.TimeSpent.TotalHours.ToString("F2")
        </div>
    };

    private RenderFragment<ProjecttimeModel> ResponseTextTemplate => item => __builder =>
    {
        @if (!string.IsNullOrEmpty(item.ResponseText))
        {
            <div @onclick="@(() => CopyToClipboard(item.ResponseText))"
                 style="cursor: pointer;"
                 title="Click to copy">
                <span style="font-weight: bold; color: var(--rz-primary);">@item.ResponseText</span>
            </div>
        }
        else
        {
            <div
                @onclick="@(() => CopyToClipboard(_projectLookup.GetValueOrDefault(item.ProjectId)?.DefaultResponseText ?? string.Empty))"
                style="cursor: pointer;"
                title="Click to copy">
                <span style="font-style: italic; color: var(--rz-text-secondary-color);">
                    @_projectLookup.GetValueOrDefault(item.ProjectId)?.DefaultResponseText
                </span>
            </div>
        }
    };

    protected override async Task OnInitializedAsync()
    {
        SetWeekFromDate(_selectedDate);
        _projects = await ProjectService.GetProjectsAsync();
        _projectLookup = _projects.ToDictionary(p => p.ProjectId);
        _defaultProject = _projects.FirstOrDefault(p => p.IsDefault);
        _dailyWorkingHours = (await EmployeeContextService.GetOrCreateCurrentEmployeeAsync()).DailyWorkingTimeInHours;
        await UpdateWorkdayDataAsync();
    }

    private async Task UpdateWorkdayDataAsync()
    {
        _workdays = await WorkdayService.GetWorkdaysAsync(_dateRangeStart, _dateRangeEnd);
        _projecttimes = await ProjecttimeService.GetProjecttimesAsync(_dateRangeStart, _dateRangeEnd);
        _officeDays = await WorkdayService.GetOfficeDaysCountAsync(_dateRangeStart, _dateRangeEnd);
        _missingWorktimeDates.Clear();

        foreach (var workday in _workdays)
        {
            if (workday.Type.IsNonWorkingDay())
                continue;

            var actualWorktime = await WorkdayService.GetTotalWorktimeAsync(workday.WorkdayId);
            var actualWorktimeHours = actualWorktime.TotalHours == 0 ? _dailyWorkingHours : actualWorktime.TotalHours;
            if (actualWorktime == TimeSpan.Zero)
                _missingWorktimeDates.Add(workday.Date);

            var totalDailyProjecttime = _projecttimes
                .Where(pt => pt.WorkdayId == workday.WorkdayId)
                .Sum(pt => pt.TimeSpent.TotalHours);

            if (totalDailyProjecttime >= actualWorktimeHours)
                continue;

            var defaultProjecttime = new ProjecttimeModel
            {
                WorkdayId = workday.WorkdayId,
                ProjectId = _defaultProject?.ProjectId ?? Guid.Empty,
                TimeSpent = TimeSpan.FromHours(actualWorktimeHours - totalDailyProjecttime)
            };
            _projecttimes.Add(defaultProjecttime);
        }

        // Dictionary Lookups for better performance during sorting
        var workdayLookup = _workdays.ToDictionary(w => w.WorkdayId, w => w.Date);
        var projectLookup = _projects.ToDictionary(p => p.ProjectId, p => p.Name);

        _projecttimes = _projecttimes
            .OrderBy(pt => workdayLookup.TryGetValue(pt.WorkdayId, out var date) ? date : DateTime.MaxValue)
            .ThenBy(pt => projectLookup.TryGetValue(pt.ProjectId, out var name) ? name : string.Empty)
            .ToList();
        _missingWorktimeDates = _missingWorktimeDates.Distinct().OrderBy(d => d).ToList();

        _totalWorkingHours = await GetTotalWorkingHours();
        _weeklyOvertime = CalculateWeeklyOvertime();
        _monthlyOvertime = await CalculateMonthlyOvertime();

        StateHasChanged();
    }

    private async Task OnCurrentDateChanged(DateTime date)
    {
        _selectedDate = new DateTime(date.Year, date.Month, date.Day);
        SetWeekFromDate(_selectedDate);
        await UpdateWorkdayDataAsync();
    }

    private void SetWeekFromDate(DateTime date)
    {
        _dateRangeStart = GetStartOfWeek(date);
        _dateRangeEnd = _dateRangeStart.AddDays(6).Date;
    }

    private static DateTime GetStartOfWeek(DateTime date)
    {
        var diff = (7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7;
        return date.Date.AddDays(-diff);
    }

    private async Task PrevWeek()
    {
        _selectedDate = _dateRangeStart.AddDays(-7);
        SetWeekFromDate(_selectedDate);
        await UpdateWorkdayDataAsync();
    }

    private async Task NextWeek()
    {
        _selectedDate = _dateRangeStart.AddDays(7);
        SetWeekFromDate(_selectedDate);
        await UpdateWorkdayDataAsync();
    }

    private async Task<TimeSpan> GetTotalWorkingHours()
    {
        var totalHours = await WorktimeService.GetTotalWorktimeAsync(_dateRangeStart, _dateRangeEnd);
        return totalHours ?? TimeSpan.Zero;
    }

    private TimeSpan CalculateWeeklyOvertime()
    {
        var expectedHours = _workdays.Count(w => w.Type.IsWorkingDay()) * _dailyWorkingHours;
        var actualHours = _totalWorkingHours.TotalHours;
        return TimeSpan.FromHours(actualHours - expectedHours);
    }

    private async Task<TimeSpan> CalculateMonthlyOvertime()
    {
        var monthStart = new DateTime(_selectedDate.Year, _selectedDate.Month, 1);
        var monthEnd = monthStart.AddMonths(1).AddDays(-1);

        var monthWorkdays = await WorkdayService.GetWorkdaysAsync(monthStart, monthEnd);
        var expectedHours = monthWorkdays.Count(w => w.Type.IsWorkingDay()) * _dailyWorkingHours;

        var actualHours = await WorktimeService.GetTotalWorktimeAsync(monthStart, monthEnd);
        return actualHours.HasValue
            ? TimeSpan.FromHours(actualHours.Value.TotalHours - expectedHours)
            : TimeSpan.Zero;
    }

    private string GetOvertimeColor(TimeSpan overtime)
    {
        return overtime.TotalHours >= 0
            ? "color: var(--rz-success)"
            : "color: var(--rz-danger)";
    }

    private static string GetWorkdayEditPath(DateTime date)
    {
        return $"/?date={date:yyyy-MM-dd}";
    }

    // I want to aggregate the projecttimes by ProjectId and sum their TimeSpent if the ResponseText is the same or empty.
    private List<ProjecttimeModel> AggregateProjecttimes()
    {
        var aggregated = new Dictionary<(Guid ProjectId, string ResponseText), ProjecttimeModel>();

        foreach (var pt in _projecttimes)
        {
            var key = (pt.ProjectId, pt.ResponseText ?? string.Empty);
            if (aggregated.ContainsKey(key))
            {
                aggregated[key].TimeSpent += pt.TimeSpent;
            }
            else
            {
                aggregated[key] = new ProjecttimeModel
                {
                    ProjectId = pt.ProjectId,
                    ResponseText = pt.ResponseText,
                    TimeSpent = pt.TimeSpent
                };
            }
        }

        return aggregated.Values.ToList();
    }

    private async Task CopyToClipboard(string text)
    {
        if (string.IsNullOrEmpty(text))
            return;

        await JsRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
        NotificationService.Notify(NotificationSeverity.Info, $"Copied to clipboard: {text}", duration: 3000);
    }

    private double GetTotalTimeSpent()
    {
        return _projecttimes.Sum(pt => pt.TimeSpent.TotalHours);
    }

    private double GetAggregatedTotalTimeSpent()
    {
        return AggregateProjecttimes().Sum(pt => pt.TimeSpent.TotalHours);
    }

}